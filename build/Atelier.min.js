
/*
 * -----------------------------------------------------------------------------
 | AtelierJS - A scene management module for CreateJS 
 | By Florian Brueckner http://bloomingbridges.co.uk/
 | MIT Licensed.
 * -----------------------------------------------------------------------------
 */

(function(e){function a(a,b,d,c,e){this._listener=b;this._isOnce=d;this.context=c;this._signal=a;this._priority=e||0}function b(a,b){if(typeof a!=="function")throw Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",b));}var c={VERSION:"0.7.4"};a.prototype={active:!0,params:null,execute:function(a){var b;this.active&&this._listener&&(a=this.params?this.params.concat(a):a,b=this._listener.apply(this.context,a),this._isOnce&&this.detach());return b},detach:function(){return this.isBound()?
this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},getListener:function(){return this._listener},_destroy:function(){delete this._signal;delete this._listener;delete this.context},isOnce:function(){return this._isOnce},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}};c.Signal=function(){this._bindings=[];this._prevParams=null};c.Signal.prototype={memorize:!1,_shouldPropagate:!0,
active:!0,_registerListener:function(b,f,d,c){var e=this._indexOfListener(b,d);if(e!==-1){if(b=this._bindings[e],b.isOnce()!==f)throw Error("You cannot add"+(f?"":"Once")+"() then add"+(!f?"":"Once")+"() the same listener without removing the relationship first.");}else b=new a(this,b,f,d,c),this._addBinding(b);this.memorize&&this._prevParams&&b.execute(this._prevParams);return b},_addBinding:function(b){var a=this._bindings.length;do--a;while(this._bindings[a]&&b._priority<=this._bindings[a]._priority);
this._bindings.splice(a+1,0,b)},_indexOfListener:function(b,a){for(var d=this._bindings.length,c;d--;)if(c=this._bindings[d],c._listener===b&&c.context===a)return d;return-1},has:function(b,a){return this._indexOfListener(b,a)!==-1},add:function(a,c,d){b(a,"add");return this._registerListener(a,!1,c,d)},addOnce:function(a,c,d){b(a,"addOnce");return this._registerListener(a,!0,c,d)},remove:function(a,c){b(a,"remove");var d=this._indexOfListener(a,c);d!==-1&&(this._bindings[d]._destroy(),this._bindings.splice(d,
1));return a},removeAll:function(){for(var a=this._bindings.length;a--;)this._bindings[a]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(a){if(this.active){var b=Array.prototype.slice.call(arguments),c=this._bindings.length,e;if(this.memorize)this._prevParams=b;if(c){e=this._bindings.slice();this._shouldPropagate=!0;do c--;while(e[c]&&this._shouldPropagate&&e[c].execute(b)!==!1)}}},forget:function(){this._prevParams=
null},dispose:function(){this.removeAll();delete this._bindings;delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};typeof define==="function"&&define.amd?define(c):typeof module!=="undefined"&&module.exports?module.exports=c:e.signals=c})(this);
(function(){var e=!1,a=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(b){function c(){!e&&this.init&&this.init.apply(this,arguments)}var g=this.prototype;e=!0;var f=new this;e=!1;for(var d in b)f[d]=typeof b[d]=="function"&&typeof g[d]=="function"&&a.test(b[d])?function(a,b){return function(){var c=this._super;this._super=g[a];var d=b.apply(this,arguments);this._super=c;return d}}(d,b[d]):b[d];c.prototype=f;c.prototype.constructor=c;c.extend=arguments.callee;
return c}})();var AtelierJS={};
(function(e){AtelierJS.Souvenirs={assets:{},sprites:{},sounds:{},register:function(a,b){this.assets[a]=loader.addImage(b)},add:function(a,b,c){if(!this.sprites[a]||c)this.sprites[a]=b;else throw Error("Souvenir '"+a+"' already exists!");},clone:function(a){if(a in this.sprites)return this.sprites[a].clone(!0)}};e.Souvenirs=AtelierJS.Souvenirs;AtelierJS.Curator={scenes:{},currentScene:{},nextScene:{},transitioning:!1,registerCollection:function(a,b){this.scenes=a;b&&(this.switchTo(b===!0?Object.keys(this.scenes).shift():
b),Ticker.addListener(this))},tick:function(){if(this.currentScene instanceof AtelierJS.Scene)this.transitioning===!0?(this.currentScene.disappear(),this.nextScene.appear()):this.transitioning==="ready"?(this.transitioning=!1,console.log("Transition finished!"),stage.removeChild(Curator.currentScene.subStage),this.currentScene=this.nextScene):this.currentScene.update()},switchTo:function(a){console.log("Switching to: "+a);this.currentScene instanceof AtelierJS.Scene&&this.currentScene.destroy();this.currentScene=
new this.scenes[a].scene(this.scenes[a].blueprint)},transitionTo:function(a){console.log("Transitioning to: "+a);this.nextScene=new this.scenes[a].scene(this.scenes[a].blueprint);this.currentScene.disappeared.add(this.endTransition);this.nextScene.appeared.add(this.endTransition);this.transitioning=!0},endTransition:function(){console.log("New scene has appeared.");Curator.transitioning="ready"}};e.Curator=AtelierJS.Curator;AtelierJS.StateMachine=function(){this.states={OFF:0,ON:1};this.currentState=
1;this.changed=new signals.Signal;this.registerStates=function(a){for(var b=0;b<a.length;b++)this.states[a[b].toUpperCase()]=parseInt(b)+2};this.setState=function(a){this.changed.dispatch(a,this.currentState);if(this.states[a])this.currentState=this.states[a]}};AtelierJS.Scene=Class.extend({init:function(a){this.subStage=new Container;stage.addChild(this.subStage);this.appeared=new signals.Signal;this.disappeared=new signals.Signal;a&&typeof a==="object"&&a.info&&(console.log("Loading Scene blueprint.."),
this.construct(a))},construct:function(a){for(x in a.actors){var b=a.actors[x],c={};Souvenirs.sprites[b.sid]?(c=Souvenirs.clone(b.sid),console.log("Using cached version")):(c=this.forge(b),Souvenirs.add(b.sid,c));var e=RegExp(/(\w+)\[(\d+?)\]/),f=e.exec(b.id);if(f&&f[2]>1){console.log("Adding "+f[2]+" "+b.type+"s");e=e.exec(b.id)[1];this[e]=[];for(var d=0;d<f[2];d++)c=Souvenirs.clone(b.sid),this[e][d]=this.place(c,b)}else this[b.id]=this.place(c,b)}},forge:function(a){switch(!0){case a.type==="Layer":return new Container;
case a.type==="Sprite":return new Bitmap(a.img);case a.type==="MovieClip":return new BitmapAnimation(new SpriteSheet(a.spritesheet));default:throw Error("Type not (yet) recognised.");}},place:function(a,b){a.x=b.hasOwnProperty("x")?b.x:0;a.y=b.hasOwnProperty("y")?b.y:0;a.vX=b.hasOwnProperty("vX")?b.vX:0;a.vY=b.hasOwnProperty("vY")?b.vY:0;a.visible=b.hasOwnProperty("visible")?b.visible:!0;a.snapToPixel=b.hasOwnProperty("snapToPixel")?b.snapToPixel:!0;b.hasOwnProperty("play")?a.gotoAndPlay(b.play):
b.stop&&a.gotoAndStop(b.stop);this.subStage.addChild(a);return a},update:function(){},onStateChanged:function(a){console.log("State changed to: "+a)},appear:function(){},disappear:function(){},destroy:function(){stage.removeChild(this.subStage)},registerStates:function(a){if(!this.states){var b=new AtelierJS.StateMachine;this.states=b.states;this.currentState=b.currentState;this.changed=b.changed;this.changed.add(this.onStateChanged);this.registerStates=b.registerStates;this.setState=b.setState;this.registerStates(a)}}})})(window);
